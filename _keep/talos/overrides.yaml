# Provides machine specific configuration options.
machine:
  kubelet:
    extraArgs:
      rotate-server-certificates: true
      feature-gates: GracefulNodeShutdown=true

  network:
    nameservers:
      - 10.1.10.1
    interfaces:
      - interface: eth0
        dhcp: true
        vip:
          ip: 10.1.10.20
    extraHostEntries:
      - ip: 10.1.10.1
        aliases:
          - gw
          - gw.lan.fireflash.cc
      - ip: 10.1.10.10
        aliases:
          - apollo
          - apollo.lan.fireflash.cc

  time:
    servers:
      - 10.1.10.5
      - time.cloudflare.com

  sysctls:
    vm.nr_hugepages: 1024

  install:
    disk: /dev/nvme0n1
    bootloader: true
    wipe: true
    extraKernelArgs:
      - talos.platform=metal
      - pcie_aspm=off

  files:
    - path: /var/../usr/etc/udev/rules.d/99-intel-gpu.rules
      permissions: 0o644
      op: create
      content: |-
        SUBSYSTEM=="drm", KERNEL=="card*", GROUP="44", MODE="0660"
        SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0660"

# Provides cluster specific configuration options.
cluster:
  controlPlane:
    endpoint: https://10.1.10.20:6443

  clusterName: starstreak

  allowSchedulingOnMasters: true

  network:
    dnsDomain: cluster.local
    podSubnets:
      - 10.200.0.0/16
    serviceSubnets:
      - 10.210.0.0/16
  #    cni:
  #      name: custom # Name of CNI to use.
  #      urls:
  #        - https://docs.projectcalico.org/manifests/tigera-operator.yaml

  apiServer:
    certSANs:
      - 10.1.10.20

  extraManifests:
    - https://raw.githubusercontent.com/alex1989hu/kubelet-serving-cert-approver/main/deploy/standalone-install.yaml
    - https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
#
#  inlineManifests:
#    - name: calico-intallation
#      contents: |-
#        apiVersion: operator.tigera.io/v1
#        kind: Installation
#        metadata:
#          name: default
#        spec:
#          calicoNetwork:
#            # Note: The ipPools section cannot be modified post-install.
#            ipPools:
#            - blockSize: 26
#              cidr: 10.200.0.0/16
#              encapsulation: VXLANCrossSubnet
#              natOutgoing: Enabled
#              nodeSelector: all()
#
